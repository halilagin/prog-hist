<!--
see: https://bl.ocks.org/mqg/c4f70354e9d05b80f1d4

-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Brush Extent 2D</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
  <style>
    rect.background{
      stroke:none;
      fill:#eeeeee;
      opacity: 1;
    }
    .brush .extent {
      stroke: #fff;
      fill-opacity: .125;
      shape-rendering: crispEdges;
    }
    .end circle{
      stroke: none;
      fill: #f57c00;
    }
  </style>
</head>
<body>
<svg></svg>

<script type="text/javascript">
  var ellipseParams = [{'r': -0.99, 'rx': 1.4106735979665885, 'ry': 0.10000000000000005, 'angle': 45.000000000000007}, {'r': -0.97, 'rx': 1.4035668847618199, 'ry': 0.17320508075688781, 'angle': 45.000000000000007}, {'r': -0.95, 'rx': 1.3964240043768941, 'ry': 0.22360679774997858, 'angle': 45.000000000000007}, {'r': -0.9299999999999999, 'rx': 1.3892443989449805, 'ry': 0.26457513110645919, 'angle': 45.000000000000007}, {'r': -0.91, 'rx': 1.3820274961085255, 'ry': 0.29999999999999993, 'angle': 45.000000000000007}, {'r': -0.89, 'rx': 1.374772708486752, 'ry': 0.33166247903553997, 'angle': 45.000000000000007}, {'r': -0.87, 'rx': 1.3674794331177342, 'ry': 0.36055512754639862, 'angle': 45.000000000000007}, {'r': -0.85, 'rx': 1.3601470508735443, 'ry': 0.38729833462074187, 'angle': 45.0}, {'r': -0.83, 'rx': 1.3527749258468684, 'ry': 0.41231056256176624, 'angle': 45.000000000000007}, {'r': -0.81, 'rx': 1.3453624047073711, 'ry': 0.43588989435406728, 'angle': 45.000000000000007}, {'r': -0.79, 'rx': 1.3379088160259651, 'ry': 0.45825756949558394, 'angle': 45.000000000000007}, {'r': -0.77, 'rx': 1.3304134695650072, 'ry': 0.47958315233127191, 'angle': 45.000000000000007}, {'r': -0.75, 'rx': 1.3228756555322954, 'ry': 0.49999999999999978, 'angle': 45.000000000000007}, {'r': -0.73, 'rx': 1.3152946437965904, 'ry': 0.51961524227066325, 'angle': 45.000000000000007}, {'r': -0.71, 'rx': 1.3076696830622021, 'ry': 0.53851648071345037, 'angle': 45.000000000000007}, {'r': -0.69, 'rx': 1.3, 'ry': 0.55677643628300222, 'angle': 45.000000000000007}, {'r': -0.6699999999999999, 'rx': 1.2922847983320085, 'ry': 0.57445626465380295, 'angle': 45.000000000000007}, {'r': -0.6499999999999999, 'rx': 1.2845232578665129, 'ry': 0.5916079783099617, 'angle': 45.000000000000007}, {'r': -0.63, 'rx': 1.2767145334803705, 'ry': 0.60827625302982191, 'angle': 45.000000000000007}, {'r': -0.61, 'rx': 1.2688577540449519, 'ry': 0.62449979983983983, 'angle': 45.000000000000007}, {'r': -0.59, 'rx': 1.2609520212918492, 'ry': 0.64031242374328501, 'angle': 45.0}, {'r': -0.5700000000000001, 'rx': 1.2529964086141667, 'ry': 0.65574385243020006, 'angle': 45.000000000000007}, {'r': -0.55, 'rx': 1.2449899597988732, 'ry': 0.67082039324993692, 'angle': 45.000000000000007}, {'r': -0.53, 'rx': 1.2369316876852983, 'ry': 0.68556546004010444, 'angle': 45.000000000000007}, {'r': -0.51, 'rx': 1.2288205727444508, 'ry': 0.69999999999999996, 'angle': 45.000000000000007}, {'r': -0.49, 'rx': 1.2206555615733703, 'ry': 0.71414284285428498, 'angle': 45.000000000000007}, {'r': -0.47, 'rx': 1.2124355652982142, 'ry': 0.72801098892805183, 'angle': 45.0}, {'r': -0.44999999999999996, 'rx': 1.2041594578792296, 'ry': 0.74161984870956632, 'angle': 45.0}, {'r': -0.42999999999999994, 'rx': 1.1958260743101399, 'ry': 0.75498344352707503, 'angle': 45.0}, {'r': -0.41000000000000003, 'rx': 1.1874342087037917, 'ry': 0.76811457478686085, 'angle': 45.000000000000007}, {'r': -0.39, 'rx': 1.1789826122551597, 'ry': 0.78102496759066542, 'angle': 45.000000000000007}, {'r': -0.37, 'rx': 1.1704699910719625, 'ry': 0.79372539331937708, 'angle': 45.000000000000007}, {'r': -0.35, 'rx': 1.1618950038622251, 'ry': 0.80622577482985502, 'angle': 45.000000000000007}, {'r': -0.32999999999999996, 'rx': 1.1532562594670797, 'ry': 0.81853527718724506, 'angle': 45.000000000000007}, {'r': -0.30999999999999994, 'rx': 1.1445523142259597, 'ry': 0.83066238629180744, 'angle': 45.000000000000007}, {'r': -0.2899999999999999, 'rx': 1.1357816691600546, 'ry': 0.84261497731763602, 'angle': 45.0}, {'r': -0.27, 'rx': 1.1269427669584644, 'ry': 0.8544003745317531, 'angle': 45.0}, {'r': -0.25, 'rx': 1.1180339887498949, 'ry': 0.8660254037844386, 'angle': 45.000000000000007}, {'r': -0.22999999999999998, 'rx': 1.1090536506409416, 'ry': 0.87749643873921224, 'angle': 45.000000000000007}, {'r': -0.20999999999999996, 'rx': 1.1000000000000001, 'ry': 0.88881944173155891, 'angle': 45.000000000000007}, {'r': -0.18999999999999995, 'rx': 1.0908712114635715, 'ry': 0.90000000000000002, 'angle': 45.000000000000007}, {'r': -0.16999999999999993, 'rx': 1.0816653826391966, 'ry': 0.91104335791442992, 'angle': 45.000000000000007}, {'r': -0.15000000000000002, 'rx': 1.0723805294763609, 'ry': 0.92195444572928875, 'angle': 45.000000000000007}, {'r': -0.13, 'rx': 1.063014581273465, 'ry': 0.93273790530888145, 'angle': 45.0}, {'r': -0.10999999999999999, 'rx': 1.0535653752852738, 'ry': 0.94339811320566036, 'angle': 45.000000000000007}, {'r': -0.08999999999999997, 'rx': 1.0440306508910548, 'ry': 0.95393920141694566, 'angle': 45.000000000000007}, {'r': -0.06999999999999995, 'rx': 1.03440804327886, 'ry': 0.96436507609929556, 'angle': 45.000000000000007}, {'r': -0.04999999999999993, 'rx': 1.0246950765959597, 'ry': 0.97467943448089644, 'angle': 45.000000000000007}, {'r': -0.030000000000000027, 'rx': 1.014889156509222, 'ry': 0.98488578017961048, 'angle': 45.000000000000007}, {'r': -0.010000000000000009, 'rx': 1.004987562112089, 'ry': 0.99498743710661997, 'angle': 45.000000000000007}, {'r': 0.010000000000000009, 'rx': 1.004987562112089, 'ry': 0.99498743710661997, 'angle': 45.000000000000007}, {'r': 0.030000000000000027, 'rx': 1.014889156509222, 'ry': 0.98488578017961048, 'angle': 45.000000000000007}, {'r': 0.050000000000000044, 'rx': 1.0246950765959599, 'ry': 0.97467943448089633, 'angle': 45.000000000000007}, {'r': 0.07000000000000006, 'rx': 1.03440804327886, 'ry': 0.96436507609929545, 'angle': 45.0}, {'r': 0.09000000000000008, 'rx': 1.0440306508910551, 'ry': 0.95393920141694566, 'angle': 45.0}, {'r': 0.1100000000000001, 'rx': 1.0535653752852738, 'ry': 0.94339811320566036, 'angle': 45.000000000000007}, {'r': 0.13000000000000012, 'rx': 1.063014581273465, 'ry': 0.93273790530888145, 'angle': 45.000000000000007}, {'r': 0.15000000000000013, 'rx': 1.0723805294763609, 'ry': 0.92195444572928864, 'angle': 45.000000000000007}, {'r': 0.16999999999999993, 'rx': 1.0816653826391966, 'ry': 0.91104335791442992, 'angle': 45.000000000000007}, {'r': 0.18999999999999995, 'rx': 1.0908712114635715, 'ry': 0.90000000000000002, 'angle': 45.000000000000007}, {'r': 0.20999999999999996, 'rx': 1.1000000000000001, 'ry': 0.88881944173155891, 'angle': 45.000000000000007}, {'r': 0.22999999999999998, 'rx': 1.1090536506409416, 'ry': 0.87749643873921224, 'angle': 45.000000000000007}, {'r': 0.25, 'rx': 1.1180339887498949, 'ry': 0.8660254037844386, 'angle': 45.000000000000007}, {'r': 0.27, 'rx': 1.1269427669584644, 'ry': 0.8544003745317531, 'angle': 45.0}, {'r': 0.29000000000000004, 'rx': 1.1357816691600546, 'ry': 0.84261497731763579, 'angle': 45.0}, {'r': 0.31000000000000005, 'rx': 1.1445523142259597, 'ry': 0.83066238629180744, 'angle': 45.000000000000007}, {'r': 0.33000000000000007, 'rx': 1.1532562594670797, 'ry': 0.81853527718724495, 'angle': 45.000000000000007}, {'r': 0.3500000000000001, 'rx': 1.1618950038622251, 'ry': 0.80622577482985491, 'angle': 45.000000000000007}, {'r': 0.3700000000000001, 'rx': 1.1704699910719625, 'ry': 0.79372539331937708, 'angle': 45.000000000000007}, {'r': 0.3900000000000001, 'rx': 1.1789826122551597, 'ry': 0.78102496759066531, 'angle': 45.000000000000007}, {'r': 0.41000000000000014, 'rx': 1.1874342087037917, 'ry': 0.76811457478686074, 'angle': 45.0}, {'r': 0.42999999999999994, 'rx': 1.1958260743101399, 'ry': 0.75498344352707503, 'angle': 45.0}, {'r': 0.44999999999999996, 'rx': 1.2041594578792296, 'ry': 0.74161984870956632, 'angle': 45.0}, {'r': 0.47, 'rx': 1.2124355652982142, 'ry': 0.72801098892805183, 'angle': 45.0}, {'r': 0.49, 'rx': 1.2206555615733703, 'ry': 0.71414284285428498, 'angle': 45.000000000000007}, {'r': 0.51, 'rx': 1.2288205727444508, 'ry': 0.69999999999999996, 'angle': 45.000000000000007}, {'r': 0.53, 'rx': 1.2369316876852983, 'ry': 0.68556546004010444, 'angle': 45.000000000000007}, {'r': 0.55, 'rx': 1.2449899597988732, 'ry': 0.67082039324993692, 'angle': 45.000000000000007}, {'r': 0.5700000000000001, 'rx': 1.2529964086141667, 'ry': 0.65574385243020006, 'angle': 45.000000000000007}, {'r': 0.5900000000000001, 'rx': 1.2609520212918492, 'ry': 0.64031242374328479, 'angle': 45.000000000000007}, {'r': 0.6100000000000001, 'rx': 1.2688577540449522, 'ry': 0.62449979983983972, 'angle': 45.000000000000007}, {'r': 0.6300000000000001, 'rx': 1.2767145334803707, 'ry': 0.60827625302982191, 'angle': 45.0}, {'r': 0.6500000000000001, 'rx': 1.2845232578665129, 'ry': 0.59160797830996148, 'angle': 45.000000000000007}, {'r': 0.6700000000000002, 'rx': 1.2922847983320087, 'ry': 0.57445626465380273, 'angle': 45.000000000000007}, {'r': 0.69, 'rx': 1.3, 'ry': 0.55677643628300222, 'angle': 45.000000000000007}, {'r': 0.71, 'rx': 1.3076696830622021, 'ry': 0.53851648071345037, 'angle': 45.000000000000007}, {'r': 0.73, 'rx': 1.3152946437965904, 'ry': 0.51961524227066325, 'angle': 45.000000000000007}, {'r': 0.75, 'rx': 1.3228756555322954, 'ry': 0.49999999999999978, 'angle': 45.000000000000007}, {'r': 0.77, 'rx': 1.3304134695650072, 'ry': 0.47958315233127191, 'angle': 45.000000000000007}, {'r': 0.79, 'rx': 1.3379088160259651, 'ry': 0.45825756949558394, 'angle': 45.000000000000007}, {'r': 0.81, 'rx': 1.3453624047073711, 'ry': 0.43588989435406728, 'angle': 45.000000000000007}, {'r': 0.8300000000000001, 'rx': 1.3527749258468684, 'ry': 0.41231056256176596, 'angle': 45.000000000000007}, {'r': 0.8500000000000001, 'rx': 1.3601470508735443, 'ry': 0.38729833462074159, 'angle': 45.000000000000007}, {'r': 0.8700000000000001, 'rx': 1.3674794331177345, 'ry': 0.36055512754639879, 'angle': 45.000000000000007}, {'r': 0.8900000000000001, 'rx': 1.374772708486752, 'ry': 0.3316624790355398, 'angle': 45.000000000000007}, {'r': 0.9100000000000001, 'rx': 1.3820274961085255, 'ry': 0.29999999999999993, 'angle': 45.0}, {'r': 0.9299999999999999, 'rx': 1.3892443989449805, 'ry': 0.26457513110645919, 'angle': 45.000000000000007}, {'r': 0.95, 'rx': 1.3964240043768941, 'ry': 0.22360679774997858, 'angle': 45.000000000000007}, {'r': 0.97, 'rx': 1.4035668847618199, 'ry': 0.17320508075688781, 'angle': 45.000000000000007}, {'r': 0.99, 'rx': 1.4106735979665885, 'ry': 0.10000000000000005, 'angle': 45.000000000000007}];


</script>
<script type="text/javascript">
  var width = 70,
    height = 70;
  var corrBrushG = d3.select("svg")
      .attr("width", width)
      .attr("height", height)
    ;

  doCorrBrush(corrBrushG);

  function doCorrBrush(corrBrushG) {

    corrBrushG
      .append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)
    ;

    var sqrt05 = Math.sqrt(0.5);
    var xscale = d3.scale.linear().domain([-sqrt05, sqrt05]).range([0, width]);
    var yscale = d3.scale.linear().domain([-sqrt05, sqrt05]).range([height, 0]);
    var rscale = d3.scale.linear().domain([0, 1]).range([0, width]);

    var corrBrush_brush = d3.svg.brush()
        .x(xscale)
        .y(yscale)
        .extent([[1, 1], [1, 1]])
        .on("brush", brushing)
      ;

    corrBrushG
      .append("g")
      .attr("class", "brush")
      .call(corrBrush_brush)
    ;



    corrBrushG
      .data([0])
      .append("ellipse")
      .attr("class", "correllipse")
      .attr("cx", xscale(0))
      .attr("cy", yscale(0))
      .attr("rx", rscale(0.99 / 2))
      .attr("ry", rscale(0.99 / 2))
      .attr("fill", "none")
      .attr("stroke", "#000")

    ;


    function cartesian2Polar(x, y) {
      var r = Math.sqrt(x * x + y * y)
      var radian = Math.atan2(y, x) //This takes y first
      var degree = radian * (180 / Math.PI)

      polarCoor = {r: r, radian: radian, degree: (360 + degree) % 360};
      return polarCoor;
    }

    function brushing() {
      var brushing_extent = corrBrush_brush.extent();

      var polar = cartesian2Polar(brushing_extent[0][0], brushing_extent[0][1]); //r and theta and degrees, polar.r, polar.radian, polar.degree
      console.log("polar", polar);

      //  svg.selectAll(".correllipse")
//    .data([0])
//    .enter()

      //1-> in coords 1 and 3, -1 -> in coords 2 or 4
      var coord = ( (polar.degree >= 0 && polar.degree < 90) || (polar.degree >= 180 && polar.degree < 270)) ? 1 : -1;


      var ellipseParam = ellipseParams.filter((d, i) => {
        if (i < (ellipseParams.length - 1))
          return (coord * polar.r) <= d.r;

        return false;
      })[0];


      corrBrushG
        .selectAll(".correllipse")
        .attr("class", "correllipse")
        .attr("cx", xscale(0))
        .attr("cy", yscale(0))
        .attr("rx", rscale(ellipseParam.rx / 2))
        .attr("ry", rscale(ellipseParam.ry / 2))
        .attr("fill", "none")
        .attr("stroke", "#000")
        .attr("transform", (d, i) => {
          return "rotate(" + (-1 * coord * ellipseParam.angle) + "," + xscale(0) + "," + yscale(0) + ")"
        });
      ;
    }

  }



</script>
</body>
</html>
